# This workflow is provided via the organization template repository
#
# https://github.com/nextcloud/.github
# https://docs.github.com/en/actions/learn-github-actions/sharing-workflows-with-your-organization
#
# SPDX-FileCopyrightText: 2023-2024 Nextcloud GmbH and Nextcloud contributors
# SPDX-License-Identifier: MIT

name: Update dependencies

on:
  workflow_dispatch:
  schedule:
    # At 3:00 on Sundays
    - cron: '0 3 * * 0'

permissions:
  contents: read

jobs:
  update-npm-dependencies:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        branches: ['main']

    name: update-npm-dependencies-${{ matrix.branches }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          ref: ${{ matrix.branches }}

      - name: Read package.json node and npm engines version
        uses: skjnldsv/read-package-engines-version-actions@06d6baf7d8f41934ab630e97d9e6c0bc9c9ac5e4 # v3
        id: versions
        with:
          fallbackNode: '^20'
          fallbackNpm: '^10'

      - name: Set up node ${{ steps.versions.outputs.nodeVersion }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ steps.versions.outputs.nodeVersion }}

      - name: Set up npm ${{ steps.versions.outputs.npmVersion }}
        run: npm i -g 'npm@${{ steps.versions.outputs.npmVersion }}'

      - name: Update npm dependencies
        id: npm-update
        run: |
          # Update dependencies to their latest versions
          npm update --save
          npm update --save-dev
          
          # Check if there are any changes
          if git diff --quiet package.json package-lock.json; then
            echo "No npm dependency updates available"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # Create a summary of changes
            echo "## NPM Dependency Updates" > npm-changes.md
            echo "" >> npm-changes.md
            git diff package.json >> npm-changes.md
          fi

      - name: Run npm ci and npm run build
        if: steps.npm-update.outputs.has_changes == 'true'
        env:
          CYPRESS_INSTALL_BINARY: 0
        run: |
          npm ci
          npm run build --if-present

      - name: Run tests
        if: steps.npm-update.outputs.has_changes == 'true'
        run: |
          npm run test --if-present || echo "No tests configured"

      - name: Create Pull Request for npm updates
        if: steps.npm-update.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ secrets.COMMAND_BOT_PAT }}
          commit-message: 'chore(deps): Update npm dependencies'
          committer: GitHub <noreply@github.com>
          author: nextcloud-command <nextcloud-command@users.noreply.github.com>
          signoff: true
          branch: automated/noid/${{ matrix.branches }}-update-npm-dependencies
          title: '[${{ matrix.branches }}] Update npm dependencies'
          body: |
            Auto-generated update of npm dependencies
            
            This PR updates npm dependencies to their latest compatible versions.
          labels: |
            dependencies
            3. to review

  update-composer-dependencies:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        branches: ['main']

    name: update-composer-dependencies-${{ matrix.branches }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          ref: ${{ matrix.branches }}
          submodules: true

      - name: Set up php8.2
        uses: shivammathur/setup-php@cf4cade2721270509d5b1c766ab3549210a39a2a # v2.33.0
        with:
          php-version: 8.2
          # https://docs.nextcloud.com/server/stable/admin_manual/installation/source_installation.html#prerequisites-for-manual-installation
          extensions: bz2, ctype, curl, dom, fileinfo, gd, iconv, intl, json, libxml, mbstring, openssl, pcntl, posix, session, simplexml, xmlreader, xmlwriter, zip, zlib, sqlite, pdo_sqlite
          coverage: none
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Read codeowners
        id: codeowners
        run: |
          grep '/appinfo/info.xml' .github/CODEOWNERS | cut -f 2- -d ' ' | xargs | awk '{ print "codeowners="$0 }' >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Update composer dependencies
        id: composer-update
        run: |
          composer install
          composer update --no-dev
          
          # Check if there are any changes
          if git diff --quiet composer.json composer.lock; then
            echo "No composer dependency updates available"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Raise on issue on failure
        uses: dacbd/create-issue-action@cdb57ab6ff8862aa09fee2be6ba77a59581921c2 # v2.0.0
        if: ${{ failure() && steps.composer-update.conclusion == 'failure' }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: 'Failed to update composer dependencies'
          body: 'Please check the output of the GitHub action and manually resolve the issues<br>${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}<br>${{ steps.codeowners.outputs.codeowners }}'

      - name: Reset checkout 3rdparty
        if: steps.composer-update.outputs.has_changes == 'true'
        run: |
          git clean -f 3rdparty
          git checkout 3rdparty
        continue-on-error: true

      - name: Reset checkout vendor
        if: steps.composer-update.outputs.has_changes == 'true'
        run: |
          git clean -f vendor
          git checkout vendor
        continue-on-error: true

      - name: Reset checkout vendor-bin
        if: steps.composer-update.outputs.has_changes == 'true'
        run: |
          git clean -f vendor-bin
          git checkout vendor-bin
        continue-on-error: true

      - name: Create Pull Request for composer updates
        if: steps.composer-update.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ secrets.COMMAND_BOT_PAT }}
          commit-message: 'chore(deps): Update composer dependencies'
          committer: GitHub <noreply@github.com>
          author: nextcloud-command <nextcloud-command@users.noreply.github.com>
          signoff: true
          branch: 'automated/noid/${{ matrix.branches }}-update-composer-dependencies'
          title: '[${{ matrix.branches }}] Update composer dependencies'
          body: |
            Auto-generated update of composer dependencies
            
            This PR updates composer dependencies to their latest compatible versions.
          labels: |
            dependencies
            3. to review
